
name: ci

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025

    steps:
      - uses: actions/checkout@v4
      - name: Install Debugging Tools via Visual Studio Installer
        shell: pwsh
        run: |
          $sdkPath = "$env:TEMP\sdksetup.exe"
          $logPath = "$env:TEMP\sdk.log"

          Write-Host "Downloading Windows SDK installer..."
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/?linkid=2338977" -OutFile $sdkPath

          Write-Host "Running Windows SDK installer (Debugging Tools only)..."
          $args = '/quiet /norestart /features OptionId.WindowsDesktopDebuggers /log "{0}"' -f $logPath
          $p = Start-Process -FilePath $sdkPath -ArgumentList $args -PassThru -Wait

          Write-Host "Installer exited with code $($p.ExitCode)"

          Write-Host "Checking for cdb.exe..."
          $cdb = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\cdb.exe" -ErrorAction SilentlyContinue
          if (-not $cdb) {
            Write-Warning "cdb.exe not found. Dumping last 200 lines of the installer log:"
            if (Test-Path $logPath) {
              Get-Content $logPath -Tail 200
            }
            throw "cdb.exe was not installed"
          } else {
            Write-Host "Found: $($cdb.FullName)"
          }


          Write-Host "Checking for cdb.exe..."
          Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\" -Recurse | Select-Object FullName

      - name: Upload SDK install log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sdk-install-log
          path: sdk.log
